#!/bin/sh
set -e

PREREQ=""

prereqs() {
    echo "$PREREQ"
}

case "$1" in
prereqs)
    prereqs
    exit 0
    ;;
esac

# Define possible locations for the Netbird binary
NETBIRD_BIN_LOCATIONS="/usr/bin/netbird /bin/netbird /sbin/netbird"
NETBIRD_BIN=""

# Find the first available Netbird binary
for bin in $NETBIRD_BIN_LOCATIONS; do
    if [ -x "$bin" ]; then
        NETBIRD_BIN="$bin"
        break
    fi
done

NETBIRD_CONFIG_FILE="/etc/netbird/config.json"
NETBIRD_SOCK_FILE="/var/run/netbird.sock"
NETBIRD_LOG="/run/netbird-init.log"

# Ensure log file exists
mkdir -p /run
exec >> "$NETBIRD_LOG" 2>&1

log() {
    message="[INFO] $1"
    echo "$message"
    echo "$message" > /dev/console
}

warn() {
    message="[WARNING] $1"
    echo "$message"
    echo "$message" > /dev/console
}

error() {
    message="[ERROR] $1"
    echo "$message" >&2
    echo "$message" > /dev/console
    # Don't exit by default, return error code instead
    return 1
}

log "========= ATTEMPTING TO START NETBIRD =========="
log "time: $(date)"

# Get directory paths
CONFIG_DIR="$(dirname "$NETBIRD_CONFIG_FILE")"
SOCK_DIR="$(dirname "$NETBIRD_SOCK_FILE")"

# Ensure required directories are present in initramfs
log "Creating configuration directory..."
mkdir -p "$CONFIG_DIR"

# Custom check if directory is mounted (fallback if mountpoint not available)
check_mounted() {
    if command -v mountpoint >/dev/null 2>&1; then
        mountpoint -q "$1"
        return $?
    else
        # Fallback method using mount command
        mount | grep -q " on $1 "
        return $?
    fi
}

# Make sure directories exist
mkdir -p "/mnt/rootfs$SOCK_DIR" 2>/dev/null || warn "Could not create /mnt/rootfs$SOCK_DIR"
mkdir -p "$SOCK_DIR" 2>/dev/null || warn "Could not create $SOCK_DIR"

# Mount the socket directory if not already mounted
if ! check_mounted "$SOCK_DIR"; then
    log "Mounting Netbird socket directory..."
    
    # Only attempt mount if both directories exist
    if [ -d "/mnt/rootfs$SOCK_DIR" ] && [ -d "$SOCK_DIR" ]; then
        if mount --bind "/mnt/rootfs$SOCK_DIR" "$SOCK_DIR"; then
            log "Socket directory mounted successfully."
        else
            warn "Failed to bind-mount Netbird socket directory. Continuing anyway."
        fi
    else
        warn "Socket directories don't exist yet. Will attempt to use local socket."
    fi
else
    log "Netbird socket directory already mounted."
fi

# Start Netbird - look for binary in multiple locations if primary is missing
if [ -n "$NETBIRD_BIN" ]; then
    log "Using Netbird binary found at $NETBIRD_BIN"
    
    # First start the Netbird service
    log "Starting Netbird service..."
    if "$NETBIRD_BIN" service start --daemon-addr "unix://$NETBIRD_SOCK_FILE" --config "$NETBIRD_CONFIG_FILE"; then
        log "Netbird service started successfully."
    else
        warn "Failed to start Netbird service, but will still try to bring up the client."
    fi
    
    # Allow service to initialize
    sleep 2
    
    # Now attempt to bring up the Netbird client
    if "$NETBIRD_BIN" up --daemon-addr "unix://$NETBIRD_SOCK_FILE"; then
        log "Netbird client is up."
    else
        error "Failed to bring up Netbird client, but continuing boot process."
    fi
else
    # Try to locate binary as last resort
    for path in /usr/bin /bin /sbin; do
        if [ -x "$path/netbird" ]; then
            log "Found Netbird binary at $path/netbird"
            
            # First start the Netbird service
            log "Starting Netbird service..."
            if "$path/netbird" service start --daemon-addr "unix://$NETBIRD_SOCK_FILE" --config "$NETBIRD_CONFIG_FILE"; then
                log "Netbird service started successfully."
                
                # Allow service to initialize
                sleep 2
                
                # Now attempt to bring up the Netbird client
                if "$path/netbird" up --daemon-addr "unix://$NETBIRD_SOCK_FILE"; then
                    log "Netbird client is up."
                    exit 0
                else
                    error "Failed to bring up Netbird client, but continuing boot process."
                fi
            else
                warn "Failed to start Netbird service using $path/netbird."
            fi
        fi
    done
    error "Netbird binary not found in standard locations, but continuing boot process."
fi

log "========= NETBIRD STARTUP COMPLETE =========="
exit 0